const canvas = document.getElementById("canvas");
const textInput = document.getElementById("textInput");
const colorPicker = document.getElementById("colorPicker");
const imgInput = document.getElementById("imgInput");
const fontSelect = document.getElementById("fontSelect");
const fontSize = document.getElementById("fontSize");

let selectedElement = null;

// Drag function
function drag(el) {
  el.onmousedown = e => {
    if (e.target.className === "resize-handle") return; // skip resize
    let offsetX = e.offsetX;
    let offsetY = e.offsetY;

    document.onmousemove = e2 => {
      let x = e2.pageX - offsetX - canvas.offsetLeft;
      let y = e2.pageY - offsetY - canvas.offsetTop;
      x = Math.max(0, Math.min(x, canvas.clientWidth - el.offsetWidth));
      y = Math.max(0, Math.min(y, canvas.clientHeight - el.offsetHeight));
      el.style.left = x + "px";
      el.style.top = y + "px";
    };

    document.onmouseup = () => document.onmousemove = null;
  };
}

// Highlight selected element
function highlightSelected(el) {
  document.querySelectorAll(".draggable").forEach(d => d.style.outline = "none");
  el.style.outline = "2px dashed #ff0000";
  addResizeHandle(el);
}

// Add text
function addText() {
  const t = document.createElement("div");
  t.innerText = textInput.value;
  t.style.color = colorPicker.value;
  t.style.fontSize = fontSize.value + "px";
  t.style.fontFamily = fontSelect.value;
  t.className = "draggable";
  t.style.top = "50px";
  t.style.left = "50px";
  t.style.width = "auto";
  t.style.height = "auto";

  t.onclick = e => {
    selectedElement = t;
    e.stopPropagation();
    highlightSelected(t);
  };

  drag(t);
  canvas.appendChild(t);
}

// Add image
imgInput.onchange = e => {
  const img = document.createElement("img");
  img.src = URL.createObjectURL(e.target.files[0]);
  img.style.width = "100px";
  img.className = "draggable";
  img.style.top = "50px";
  img.style.left = "50px";

  img.onclick = e => {
    selectedElement = img;
    e.stopPropagation();
    highlightSelected(img);
  };

  drag(img);
  canvas.appendChild(img);
};

// Change font & size
function changeFont(f) { if (selectedElement && selectedElement.tagName === "DIV") selectedElement.style.fontFamily = f; }
function changeFontSize(size) { if (selectedElement && selectedElement.tagName === "DIV") selectedElement.style.fontSize = size + "px"; }

// Change background color
function changeBg(color) { canvas.style.background = color; }

// Preset gradients
function setBgGradient(color1, color2) {
  canvas.style.background = `linear-gradient(135deg, ${color1}, ${color2})`;
}

// Patterns
function setPattern(url) {
  canvas.style.background = `url(${url}) center/cover no-repeat`;
}

// Clear canvas
function clearCanvas() { canvas.innerHTML = ""; }

// Templates
function templateInstagram() {
  clearCanvas();
  setBgGradient('#ff9a9e', '#fad0c4');
  let t = document.createElement("div");
  t.innerText = "New Post!";
  t.style.fontSize = "28px";
  t.style.color = "#880e4f";
  t.style.top = "150px";
  t.style.left = "60px";
  t.className = "draggable";
  drag(t);
  canvas.appendChild(t);
}

function templateFlyer() {
  clearCanvas();
  setBgGradient('#43cea2', '#185a9d');
  let h = document.createElement("div");
  h.innerText = "EVENT TODAY";
  h.style.fontSize = "24px";
  h.style.color = "#0d47a1";
  h.style.top = "80px";
  h.style.left = "40px";
  h.className = "draggable";
  drag(h);
  canvas.appendChild(h);

  let p = document.createElement("div");
  p.innerText = "Join us at 5pm";
  p.style.top = "150px";
  p.style.left = "60px";
  p.className = "draggable";
  drag(p);
  canvas.appendChild(p);
}

// Download design
function download() {
  html2canvas(canvas).then(c => {
    const a = document.createElement("a");
    a.download = "design.png";
    a.href = c.toDataURL();
    a.click();
  });
}

// Resize handle
function addResizeHandle(el) {
  document.querySelectorAll(".resize-handle").forEach(h => h.remove());
  const handle = document.createElement("div");
  handle.className = "resize-handle";
  el.appendChild(handle);

  let startX, startY, startWidth, startHeight;

  handle.onmousedown = e => {
    e.stopPropagation();
    startX = e.clientX;
    startY = e.clientY;
    startWidth = el.offsetWidth;
    startHeight = el.offsetHeight;

    document.onmousemove = e2 => {
      let newWidth = startWidth + (e2.clientX - startX);
      let newHeight = startHeight + (e2.clientY - startY);
      el.style.width = newWidth + "px";
      el.style.height = newHeight + "px";
    };

    document.onmouseup = () => { document.onmousemove = null; };
  };
}
